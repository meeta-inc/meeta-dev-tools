.PHONY: help test-health test-chat test-chat-with-token test-invalid-token generate-token start build clean test test-coverage test-watch

# Default target
help:
	@echo "ðŸš€ AI Navi Backend Mock API Test Commands"
	@echo ""
	@echo "Available commands:"
	@echo "  make start                 - Start the mock server"
	@echo "  make build                 - Build the TypeScript project"
	@echo "  make generate-token        - Generate a test JWE token"
	@echo "  make test-health           - Test health endpoint"
	@echo "  make test-chat             - Test chat endpoint with valid token"
	@echo "  make test-chat-with-token  - Generate token and test chat endpoint"
	@echo "  make test-invalid-token    - Test chat endpoint with invalid token"
	@echo "  make test-all              - Run all API tests"
	@echo "  make test                  - Run Jest unit tests"
	@echo "  make test-coverage         - Run Jest tests with coverage"
	@echo "  make test-watch            - Run Jest tests in watch mode"
	@echo "  make clean                 - Clean build artifacts"
	@echo ""

# Server management
start:
	@echo "ðŸš€ Starting AI Navi Backend Mock Server..."
	npm start

build:
	@echo "ðŸ”¨ Building TypeScript project..."
	npm run build

clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -rf dist/

# Token generation
generate-token:
	@echo "ðŸ”‘ Generating test JWE token..."
	@node generate-token.mjs

# API Tests
test-health:
	@echo "ðŸ¥ Testing Health API..."
	@curl -s -w "\nðŸ“Š Status: %{http_code}\n" \
		http://localhost:3001/ai-navi/health | jq . 2>/dev/null || echo "Response received (jq formatting failed)"

test-chat: export TOKEN := $(shell node generate-token.mjs | grep -E '^eyJ' | head -1)
test-chat:
	@echo "ðŸ’¬ Testing Chat API with generated token..."
	@if [ -z "$(TOKEN)" ]; then \
		echo "âŒ Failed to generate token. Make sure the server dependencies are installed."; \
		exit 1; \
	fi
	@curl -s -w "\nðŸ“Š Status: %{http_code}\n" \
		-X POST http://localhost:3001/students/chat \
		-H "Content-Type: application/json" \
		-H "X-JWE-Token: $(TOKEN)" \
		-d '{ \
			"clientId": "RS000001", \
			"appId": "0001", \
			"gradeId": "elementary", \
			"userId": "testuser123", \
			"message": "ì•ˆë…•í•˜ì„¸ìš”! ìˆ˜í•™ ë¬¸ì œë¥¼ ë„ì™€ì£¼ì„¸ìš”.", \
			"sessionId": "test-session-123" \
		}' | jq . 2>/dev/null || echo "Response received (jq formatting failed)"

test-chat-with-token:
	@echo "ðŸ”‘ Generating token and testing chat API..."
	@TOKEN=$$(node generate-token.mjs | grep -E '^eyJ' | head -1) && \
	echo "Generated Token: $$TOKEN" && \
	echo "ðŸ’¬ Testing Chat API..." && \
	curl -s -w "\nðŸ“Š Status: %{http_code}\n" \
		-X POST http://localhost:3001/students/chat \
		-H "Content-Type: application/json" \
		-H "X-JWE-Token: $$TOKEN" \
		-d '{ \
			"clientId": "RS000001", \
			"appId": "0001", \
			"gradeId": "high", \
			"userId": "student456", \
			"message": "ì˜ì–´ ë¬¸ë²•ì— ëŒ€í•´ ì§ˆë¬¸ì´ ìžˆì–´ìš”." \
		}' | jq . 2>/dev/null || echo "Response received (jq formatting failed)"

test-invalid-token:
	@echo "âŒ Testing Chat API with invalid token..."
	@curl -s -w "\nðŸ“Š Status: %{http_code}\n" \
		-X POST http://localhost:3001/students/chat \
		-H "Content-Type: application/json" \
		-H "X-JWE-Token: invalid.token.here" \
		-d '{ \
			"clientId": "RS000001", \
			"appId": "0001", \
			"gradeId": "middle", \
			"userId": "testuser789", \
			"message": "ì´ í† í°ì€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." \
		}' | jq . 2>/dev/null || echo "Response received (jq formatting failed)"

test-validation:
	@echo "ðŸ” Testing request validation..."
	@echo "Testing invalid clientId format..."
	@TOKEN=$$(node generate-token.mjs | grep -E '^eyJ' | head -1) && \
	curl -s -w "\nðŸ“Š Status: %{http_code}\n" \
		-X POST http://localhost:3001/students/chat \
		-H "Content-Type: application/json" \
		-H "X-JWE-Token: $$TOKEN" \
		-d '{ \
			"clientId": "invalid", \
			"appId": "0001", \
			"gradeId": "elementary", \
			"userId": "testuser", \
			"message": "í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€" \
		}' | jq . 2>/dev/null || echo "Response received (jq formatting failed)"

test-missing-fields:
	@echo "ðŸ” Testing missing required fields..."
	@TOKEN=$$(node generate-token.mjs | grep -E '^eyJ' | head -1) && \
	curl -s -w "\nðŸ“Š Status: %{http_code}\n" \
		-X POST http://localhost:3001/students/chat \
		-H "Content-Type: application/json" \
		-H "X-JWE-Token: $$TOKEN" \
		-d '{ \
			"appId": "0001", \
			"gradeId": "elementary", \
			"message": "clientIdê°€ ì—†ëŠ” ìš”ì²­ìž…ë‹ˆë‹¤." \
		}' | jq . 2>/dev/null || echo "Response received (jq formatting failed)"

test-all: test-health test-chat-with-token test-invalid-token test-validation test-missing-fields
	@echo "âœ… All API tests completed!"

# Jest Unit Tests
test:
	@echo "ðŸ§ª Running Jest unit tests..."
	npm test

test-coverage:
	@echo "ðŸ“Š Running Jest tests with coverage..."
	npm run test:coverage

test-watch:
	@echo "ðŸ‘€ Running Jest tests in watch mode..."
	npm run test:watch

# Development helpers
dev-info:
	@echo "ðŸ“š Development Information:"
	@echo "  Server URL: http://localhost:3001"
	@echo "  API Docs: http://localhost:3001/docs"
	@echo "  Health Check: http://localhost:3001/ai-navi/health"
	@echo "  Chat Endpoint: POST http://localhost:3001/students/chat"
	@echo ""
	@echo "ðŸ”§ Required Headers for Chat API:"
	@echo "  Content-Type: application/json"
	@echo "  X-JWE-Token: [generated token]"

# Quick curl examples
curl-examples:
	@echo "ðŸ“‹ Quick curl examples:"
	@echo ""
	@echo "Health Check:"
	@echo "curl http://localhost:3001/ai-navi/health"
	@echo ""
	@echo "Chat API (replace TOKEN with actual token):"
	@echo 'curl -X POST http://localhost:3001/students/chat \'
	@echo '  -H "Content-Type: application/json" \'
	@echo '  -H "X-JWE-Token: TOKEN" \'
	@echo '  -d '"'"'{ \'
	@echo '    "clientId": "RS000001", \'
	@echo '    "appId": "0001", \'
	@echo '    "gradeId": "elementary", \'
	@echo '    "userId": "testuser123", \'
	@echo '    "message": "ì•ˆë…•í•˜ì„¸ìš”!" \'
	@echo '  }'"'"